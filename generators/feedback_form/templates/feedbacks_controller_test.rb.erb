require File.dirname(__FILE__) + '/../test_helper'

class <%= controller_class_name %>Test < ActionController::TestCase
  
  def setup
    @controller = <%= controller_class_name %>.new
    @request    = ActionController::TestRequest.new
    @response   = ActionController::TestResponse.new
  end
  
  
  def test_should_have_minimal_feedback_form
    get :new    
    assert_select "form#feedback_form", true do      
      assert_select "[action=?]", "/feedbacks" 
      assert_select "[method=?]", /post/i
      assert_select "textarea[name=?]", "feedback[comment]"
    end
  end
  
  def test_should_post_create
    post :create, :feedback => {:comment => "Great website!"}
    assert :success # Doesn't test much  
    assert_nil @error_message
  end
  
  def test_should_have_feedback_ajax_request
    get :new
    assert_select "form#feedback_form[onsubmit=?]", Regexp.new("#{Regexp.escape("new Ajax.Request('/feedbacks'")}.*")
  end
  
  def test_should_have_ajax_with_complete_callback_to_submitted
    get :new
    assert_select "form#feedback_form[onsubmit=?]", Regexp.new(".*#{Regexp.escape("onComplete:function(request){Feedback.submitted(request);}")}.*")
  end
  
  def test_should_have_ajax_with_create_callback_to_loading
    get :new
    assert_select "form#feedback_form[onsubmit=?]", Regexp.new(".*#{Regexp.escape("onCreate:function(request){Feedback.loading('Sending...');}")}.*")
  end
    
  
  def test_should_set_error_message_when_not_valid
    post :create, :feedback => {:comment => ""}
    assert !assigns(:error_message).blank?
  end
  

  protected
  
  def create_feedback(params = {})
    valid_feedback = {
      :subject => "Test",
      :email => "test@yoursite.com",
      :comment => "i like the site"
    }
    <%= model_class_name %>.new(valid_feedback.merge(params))    
  end
end
